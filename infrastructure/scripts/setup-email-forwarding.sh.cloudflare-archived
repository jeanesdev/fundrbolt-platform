#!/bin/bash
# Setup email forwarding for fundrbolt.com using CloudFlare Email Routing
# This allows receiving emails at fundrbolt.com and forwarding them to Gmail

set -euo pipefail

ENVIRONMENT="${1:-dev}"
DOMAIN="fundrbolt.com"
RESOURCE_GROUP="fundrbolt-${ENVIRONMENT}-rg"

echo "üìß Setting up Email Forwarding for fundrbolt.com"
echo "============================================="
echo ""
echo "This script will configure MX records for CloudFlare Email Routing"
echo "CloudFlare Email Routing is FREE and allows unlimited email forwarding"
echo ""

# Check if logged in
if ! az account show &> /dev/null; then
    echo "‚ùå Not logged in to Azure. Please run: az login"
    exit 1
fi

echo "üìù Adding MX records for CloudFlare Email Routing..."
echo ""

# Remove any existing MX records first
echo "Checking for existing MX records..."
az network dns record-set mx delete \
    --zone-name "$DOMAIN" \
    --resource-group "$RESOURCE_GROUP" \
    --name @ \
    --yes 2>/dev/null || echo "No existing MX records to remove"

# Add CloudFlare MX records
echo "1Ô∏è‚É£  Adding MX record (priority 1)..."
az network dns record-set mx create \
    --zone-name "$DOMAIN" \
    --resource-group "$RESOURCE_GROUP" \
    --name @ \
    --ttl 3600

az network dns record-set mx add-record \
    --zone-name "$DOMAIN" \
    --resource-group "$RESOURCE_GROUP" \
    --record-set-name @ \
    --preference 1 \
    --exchange "route1.mx.cloudflare.net"

echo "2Ô∏è‚É£  Adding MX record (priority 2)..."
az network dns record-set mx add-record \
    --zone-name "$DOMAIN" \
    --resource-group "$RESOURCE_GROUP" \
    --record-set-name @ \
    --preference 2 \
    --exchange "route2.mx.cloudflare.net"

echo "3Ô∏è‚É£  Adding MX record (priority 3)..."
az network dns record-set mx add-record \
    --zone-name "$DOMAIN" \
    --resource-group "$RESOURCE_GROUP" \
    --record-set-name @ \
    --preference 3 \
    --exchange "route3.mx.cloudflare.net"

echo ""
echo "‚úÖ MX records configured successfully!"
echo ""
echo "üìã Next Steps to Complete Setup:"
echo ""
echo "1. Go to CloudFlare Email Routing:"
echo "   https://dash.cloudflare.com/?to=/:account/:zone/email/routing/overview"
echo ""
echo "2. Click 'Get Started' or 'Add Email Routing'"
echo ""
echo "3. Add your domain: fundrbolt.com"
echo ""
echo "4. Verify domain ownership (CloudFlare will check DNS records)"
echo ""
echo "5. Create forwarding rules:"
echo "   Legal@fundrbolt.com     ‚Üí jeanes.dev@gmail.com"
echo "   Privacy@fundrbolt.com   ‚Üí jeanes.dev@gmail.com"
echo "   DPO@fundrbolt.com       ‚Üí jeanes.dev@gmail.com"
echo "   admin@fundrbolt.com     ‚Üí jeanes.dev@gmail.com"
echo ""
echo "6. Optional: Add catch-all rule for all other emails"
echo ""
echo "üí° CloudFlare Email Routing Features:"
echo "   ‚úÖ Completely FREE"
echo "   ‚úÖ Unlimited forwarding"
echo "   ‚úÖ Spam protection included"
echo "   ‚úÖ No credit card required"
echo ""
echo "üìß Note: DoNotReply@fundrbolt.com won't accept incoming emails (by design)"
echo ""
echo "‚è≥ DNS propagation: 5-30 minutes"
echo "   After that, test by sending email to Legal@fundrbolt.com"
