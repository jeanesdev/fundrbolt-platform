name: Copilot Setup Steps

on:
	workflow_dispatch:
	workflow_call:

jobs:
	setup-test-db:
		name: Setup Test Database
		runs-on: ubuntu-latest
		timeout-minutes: 15
		defaults:
			run:
				working-directory: ./backend

		env:
			ENVIRONMENT: test
			DEBUG: true
			DATABASE_URL: postgresql://postgres:postgres@localhost:5432/fundrbolt_test
			REDIS_URL: redis://localhost:6379/0
			JWT_SECRET_KEY: test-secret-key-for-ci-only-not-production-safe
			JWT_ALGORITHM: HS256
			ACCESS_TOKEN_EXPIRE_MINUTES: 15
			REFRESH_TOKEN_EXPIRE_DAYS: 7
			AZURE_COMMUNICATION_CONNECTION_STRING: ${{ secrets.AZURE_COMMUNICATION_CONNECTION_STRING_TEST }}
			AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING_TEST }}
			AZURE_STORAGE_ACCOUNT_NAME: ${{ secrets.AZURE_STORAGE_ACCOUNT_NAME_TEST }}
			EMAIL_FROM_ADDRESS: test@fundrbolt.com
			EMAIL_FROM_NAME: Fundrbolt Test
			FRONTEND_ADMIN_URL: http://localhost:5173
			FRONTEND_DONOR_URL: http://localhost:5174
			SUPER_ADMIN_EMAIL: admin@fundrbolt.com
			SUPER_ADMIN_PASSWORD: TestPassword123!
			SUPER_ADMIN_FIRST_NAME: Test
			SUPER_ADMIN_LAST_NAME: Admin
			RATE_LIMIT_LOGIN_ATTEMPTS: 5
			RATE_LIMIT_LOGIN_WINDOW_MINUTES: 15
			CORS_ORIGINS: http://localhost:5173,http://localhost:5174

		services:
			postgres:
				image: postgres:16
				env:
					POSTGRES_PASSWORD: postgres
					POSTGRES_DB: fundrbolt_test
				options: >-
					--health-cmd pg_isready
					--health-interval 10s
					--health-timeout 5s
					--health-retries 5
				ports:
					- 5432:5432

			redis:
				image: redis:7-alpine
				options: >-
					--health-cmd "redis-cli ping"
					--health-interval 10s
					--health-timeout 5s
					--health-retries 5
				ports:
					- 6379:6379

		steps:
			- name: Checkout code
				uses: actions/checkout@v4

			- name: Set up Python
				uses: actions/setup-python@v5
				with:
					python-version: "3.11"

			- name: Install Poetry
				uses: snok/install-poetry@v1
				with:
					version: latest
					virtualenvs-create: true
					virtualenvs-in-project: true

			- name: Install dependencies
				run: poetry install --no-interaction --no-root

			- name: Run migrations
				run: poetry run alembic upgrade head
